
# 게임 행동 요청 시스템 설계

## 1. 기본 흐름

1. **유저 행동 요청**  
   유저가 행동을 요청하면 (예: "사격 해줘"), 클라이언트에서 해당 요청을 서버로 전송합니다.

2. **레디스 캐시 조회**  
   - 서버는 먼저 **레디스 캐시**에서 해당 행동에 대한 응답을 찾습니다.
   - **데이터가 없으면** LLM 서버에 요청을 보냅니다.

3. **LLM 응답**  
   - LLM 서버에서 **응답을 받으면**, 해당 응답이 **적절한지 검증 AI**가 확인합니다.
   - 검증 AI가 **정상적이라 판단하면**, LLM의 응답을 클라이언트로 전달하고 **레디스에 저장**합니다.

4. **레디스 캐시**  
   - 응답을 **레디스에 저장**하여, 이후 동일한 요청이 오면 빠르게 응답할 수 있도록 합니다.

5. **미지정 행동 처리**  
   - 만약 LLM이 **미지정 행동**(정의되지 않은 행동)을 응답하면, 이를 **미지정 행동 큐**에 저장하여 **후속 검토**를 위한 목록을 작성합니다.  
   - 개발자는 이 목록을 보고 새로운 행동을 정의하거나, 필요 없는 행동을 삭제합니다.

---

## 2. 시스템 설계 특징

- **클라이언트 → 서버 → 레디스 캐시** 방식으로 데이터가 빠르게 처리되고, 서버와의 통신 횟수를 최소화합니다.
- **LLM**에서 오는 응답을 서버가 직접 처리하고, 그 결과가 **레디스에 캐시**되어 다음 요청에 대해 더 빠른 응답을 제공합니다.
- **검증 AI**는 정확한 행동 검증 후 캐시에 저장되는 방식으로 **잘못된 데이터**가 저장되는 것을 방지합니다.
- **미지정 행동 큐**는 유저의 예상치 못한 요청에 대해서, **자동으로 추가하거나 수정**하여 **향후 확장성**을 확보합니다.

---

## 3. 데이터 저장 구조

- **레디스 데이터**: 각 행동 요청을 **나라별, 대화, NPC 행동**으로 분리하여 캐시합니다. 예를 들어:
  - `{"언어": "한국어", "대화": "사격 해줘", "NPC 행동": "사격"}`

- **미지정 행동 큐**: LLM에서 미지정된 행동이 발생하면, 이를 **큐에 저장**하고 개발자가 후속 검토 후 처리합니다.

- **초기 데이터 세팅**: 처음 게임을 실행할 때, **기본 데이터를 한 번에 로드**하여 클라이언트로 전송하고, 이를 **TMap**으로 처리하여 내부 데이터를 관리합니다.

---

## 4. 시스템 확장 포인트

1. **유사 문장 정규화**:  
   - 필요시, 동일한 의미의 문장이 여러 번 캐시되는 문제를 해결하기 위해 **유사 문장 정규화** 로직을 추가할 수 있습니다.  
   - 하지만 이 로직은 **오차가 크고, 시스템 복잡도를 증가시키므로 불필요**할 수 있습니다.

2. **미지정 행동 큐**:  
   - LLM에서 발생한 **미지정 행동**은 나중에 검토하여 **업데이트**하거나 **삭제**할 수 있습니다. 이를 통해 유저의 **새로운 행동 요청**을 계속 반영할 수 있습니다.

3. **SQLite 마이그레이션**:  
   - 현 단계에서는 **SQLite** 사용이 불필요하지만, 향후 **오프라인 모드**가 필요할 경우 마이그레이션을 고려할 수 있습니다.

---

## 5. 결론

- **빠른 응답**을 위한 **레디스 캐시**를 중심으로 한 시스템.
- **LLM + 검증 AI**가 협력하여 정확한 행동 응답을 제공합니다.
- 미지정 행동은 **큐에 저장**하여 추후 검토 후 반영 가능합니다.
- 시스템은 **유연하게 확장 가능**하며, **저장소 및 데이터 관리**는 간단하게 이루어집니다.
